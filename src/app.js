'use strict';var gEngine=gEngine||{};gEngine.Core=function(){var t=null,a=function(){var T=t.canvas.clientWidth,S=t.canvas.clientHeight;t.canvas.width=T,t.canvas.height=S},n=function(T){var S=document.getElementById(T);t=S.getContext('webgl',{alpha:!1})||S.getContext('experimental-webgl',{alpha:!1});var L=t.canvas.clientWidth,F=t.canvas.clientHeight;return t.canvas.width=L,t.canvas.height=F,t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.enable(t.BLEND),null==t?void document.write('<br><b>Error: Webgl is not supported</b>'):void(window.addEventListener('resize',a),gEngine.Core.clearCanvas([0,0,0,1]))},d=function(T){gEngine.GameLoop.start(T)};return{getGL:function(){return t},initialize:function(T,S){n(T),gEngine.VertexBuffer.initialize(),gEngine.Input.initialize(),gEngine.Audio.initialize(),gEngine.Physics.initialize(),S.loadScene.call(S),gEngine.DefaultResources.initialize(function(){d(S)})},clearCanvas:function(T){t.clearColor(T[0],T[1],T[2],T[3]),t.clear(t.COLOR_BUFFER_BIT)},inheritPrototype:function(T,S){var L=Object.create(S.prototype);L.constructor=T,T.prototype=L},cleanUp:function(){gEngine.VertexBuffer.cleanUp(),gEngine.DefaultResources.cleanUp()}}}(),gEngine.VertexBuffer=function(){var t=gEngine.Core.getGL(),o={position:[0.5,0.5,0,-0.5,0.5,0,0.5,-0.5,0,-0.5,-0.5,0],textureCoordinate:{data:[1,0,0,0,1,1,0,1],drawType:35048}},a=null;return{initialize:function(){var g=gEngine.Core.getGL();a=twgl.createBufferInfoFromArrays(g,o)},getVertexBuffer:function(){return a},cleanUp:function(){var g=gEngine.Core.getGL();g.deleteBuffer(a.attribs.position.buffer),g.deleteBuffer(a.attribs.textureCoordinate.buffer)}}}(),gEngine.GameLoop=function(){var o=1e3/60,a,n,m,d,u=!0,g=!0,C=null,f=function(){if(u){for(requestAnimationFrame(function(){f.call(C)}),m=Date.now(),d=m-a,a=m,n+=d;n>=o&&u;)g&&(gEngine.Physics.update(o/100),gEngine.Input.update(),this.update(o/100)),n-=o;u&&this.draw()}else C.unloadScene()},T=function(){a=Date.now(),n=0,u=!0,requestAnimationFrame(function(){f.call(C)})},S=function(){g=!1,gEngine.Audio.pause()},L=function(){g=!0,gEngine.Audio.resume()};return{start:function(A){C=A,gEngine.ResourceMap.setLoadCompleteCallback(function(){C.initialize(),window.addEventListener('focus',L),window.addEventListener('blur',S),T()})},stop:function(){u=!1,window.removeEventListener('focus'),window.removeEventListener('blur')},onBlur:S,onFocus:L}}(),gEngine.Input=function(){var t={Left:37,Up:38,Right:39,Down:40,Space:32,Zero:48,One:49,Two:50,Three:51,Four:52,Five:53,Six:54,Seven:55,Eight:56,Nine:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LastKeyCode:222},o=[],a=[],n=[],m=[],u=null,g=[],C=[],f=[],T=-1,S=-1,L=[],F=function(te){a[te.keyCode]=!0,m[te.keyCode]=!1},P=function(te){a[te.keyCode]=!1,m[te.keyCode]=!0},R=function(te){var oe=!1,re=u.getBoundingClientRect(),ae=Math.round((te.clientX-re.left)*(u.width/re.width)),ie=Math.round((te.clientY-re.top)*(u.width/re.width));return 0<=ae&&ae<u.width&&0<=ie&&ie<u.height&&(T=ae,S=u.height-1-ie,oe=!0),oe},A=function(te){R(te)&&(C[te.button]=!0)},V=function(te){R(te),C[te.button]=!1},M=[],W=0,k=function(te){te.preventDefault();for(var oe=te.changedTouches,re=0;re<oe.length;re++)W+=1,M[oe[re].identifier]=oe[re],M[oe[re].identifier].phase='start'},O=function(te){te.preventDefault();for(var oe=te.changedTouches,re=0;re<oe.length;re++)W-=1,M[oe[re].identifier]=oe[re],M[oe[re].identifier].phase='end'},G=function(te){te.preventDefault();for(var oe=te.changedTouches,re=0;re<oe.length;re++)W-=1,M[oe[re].identifier]=oe[re],M[oe[re].identifier].phase='cancel'},_=function(te){te.preventDefault();for(var oe=te.changedTouches,re=0;re<oe.length;re++)M[oe[re].identifier]=oe[re],M[oe[re].identifier].phase='move'},H=function(){},Y=function(){};return{initialize:function(){for(let oe in t)a[t[oe]]=!1,o[t[oe]]=!1,n[t[oe]]=!1,m[t[oe]]=!0;for(let oe=0;3>oe;oe++)g[oe]=!1,C[oe]=!1,f[oe]=!1;window.addEventListener('mousedown',A),window.addEventListener('mouseup',V),window.addEventListener('mousemove',R),window.addEventListener('keyup',P),window.addEventListener('keydown',F);var te=gEngine.Core.getGL();u=te.canvas,te.canvas.addEventListener('touchstart',k,!1),te.canvas.addEventListener('touchend',O,!1),te.canvas.addEventListener('touchcancel',G,!1),te.canvas.addEventListener('touchmove',_,!1),window.addEventListener('gamepadconnected',H,!1),window.addEventListener('gamepaddisconnected',Y,!1),L=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[]},update:function(){for(let te in t)n[t[te]]=!o[t[te]]&&a[t[te]],o[t[te]]=a[t[te]];for(let te=0;3>te;te++)f[te]=!g[te]&&C[te],g[te]=C[te];L=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads:[]},isKeyPressed:function(te){return a[te]},isKeyClicked:function(te){return n[te]},isKeyUp:function(te){return m[te]},keyCodes:t,mouseButtons:{Left:0,Middle:1,Right:2},isButtonClicked:function(te){return f[te]},isButtonPressed:function(te){return C[te]},getMousePos:function(){return[T,S,0]},getMousePosX:function(){return T},getMousePosY:function(){return S},getGamepads:function(){return L},getTouches:function(){return M},getTouchCount:function(){return W},getTouch:function(te){return M[te]||null}}}(),gEngine.ResourceMap=function(){var t=function(V){this.mAsset=V,this.mRefCount=1},o={},n=null,m=0,d=0,u=null,C=function(){let V=Math.floor(100*(m/d));if(null!==u&&u(V),m===d&&null!==n){var B=n;n=null,B()}},L=function(V){return V in o};return{asyncLoadRequested:function(V){o[V]=new t(V),++d},asyncLoadCompleted:function(V,B){L(V)||console.log(V+': not in map!'),o[V].mAsset=B,m++,C()},setLoadCompleteCallback:function(V){n=V,C()},retrieveAsset:function(V){return V in o?o[V].mAsset:null},unloadAsset:function(V){if(V in o)if(o[V].mRefCount-=1,0>=o[V].mRefCount)delete o[V];else return o[V].mRefCount;return 0},isAssetLoaded:L,incAssetRefCount:function(V){o[V].mRefCount+=1},registerLoader:function(V){u=V}}}(),gEngine.TextFileLoader=function(){var t=Object.freeze({XMLFile:0,TextFile:1});return{loadTextFile:function(m,d,u){if(!gEngine.ResourceMap.isAssetLoaded(m)){gEngine.ResourceMap.asyncLoadRequested(m);var g=new XMLHttpRequest;g.onreadystatechange=function(){4===g.readyState&&200!==g.status&&console.log(m+': must be served by a web-server')},g.open('GET',m,!0),g.setRequestHeader('Content-Type','text/xml'),g.onload=function(){var C=null;if(d===t.XMLFile){var f=new DOMParser;C=f.parseFromString(g.responseText,'text/xml')}else C=g.responseText;gEngine.ResourceMap.asyncLoadCompleted(m,C),null!==u&&u!==void 0&&u(m)},g.send()}else gEngine.ResourceMap.incAssetRefCount(m),null!==u&&void 0!==u&&u(m)},unloadTextFile:function(m){gEngine.ResourceMap.unloadAsset(m)},TextFileType:t}}(),gEngine.DefaultResources=function(){var t='src/shaders/simpleVS.glsl',o='src/shaders/simpleFS.glsl',a='src/shaders/textureVS.glsl',n='src/shaders/textureFS.glsl',m='src/shaders/fontFS.glsl',d='src/shaders/pixelSnapVS.glsl',u='src/shaders/lightFS.glsl',g='assets/fonts/system-default-font',C=[0.1,0.1,0.1,1],f=1,T=null,S=null,L=null,F=null,P=null,k=function(U){S=new SimpleShader(t,o),T=new TextureShader(a,n),L=new SpriteShader(d,n),F=new SpriteShader(a,m),P=new LightShader(d,u),U()};return{initialize:function(U){gEngine.TextFileLoader.loadTextFile(t,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(o,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(a,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(n,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(m,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(d,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.TextFileLoader.loadTextFile(u,gEngine.TextFileLoader.TextFileType.TextFile),gEngine.Fonts.loadFont(g),gEngine.ResourceMap.setLoadCompleteCallback(function(){k(U)})},getColorShader:function(){return S},getTextureShader:function(){return T},getSpriteShader:function(){return L},getDefaultFont:function(){return g},getFontShader:function(){return F},cleanUp:function(){S.cleanUp(),T.cleanUp(),L.cleanUp(),F.cleanUp(),P.cleanUp(),gEngine.TextFileLoader.unloadTextFile(t),gEngine.TextFileLoader.unloadTextFile(o),gEngine.TextFileLoader.unloadTextFile(a),gEngine.TextFileLoader.unloadTextFile(n),gEngine.TextFileLoader.unloadTextFile(d),gEngine.TextFileLoader.unloadTextFile(u),gEngine.Fonts.unloadFont(g)},getGlobalAmbientColor:function(){return C},setGlobalAmbientColor:function(U){C=[U[0],U[1],U[2],U[3]]},getGlobalAmbientIntensity:function(){return f},setGlobalAmbientIntensity:function(U){f=U},getLightShader:function(){return P}}}(),gEngine.Audio=function(){var t=null,o=null,f=function(){null!==o&&(o.stop(0),o=null)};return{initialize:function(){try{window.AudioContext||window.webkitAudioContext;t=new AudioContext}catch(F){console.log('Web Audio is not supported')}},loadAudio:function(L){if(!gEngine.ResourceMap.isAssetLoaded(L)){gEngine.ResourceMap.asyncLoadRequested(L);var F=new XMLHttpRequest;F.onreadystatechange=function(){4===F.readyState&&200!==F.status&&console.log(L+': must be served by a web-server')},F.open('GET',L,!0),F.responseType='arraybuffer',F.onload=function(){t.decodeAudioData(F.response,function(P){gEngine.ResourceMap.asyncLoadCompleted(L,P)})},F.send()}else gEngine.ResourceMap.incAssetRefCount(L)},unloadAudio:function(L){gEngine.ResourceMap.unloadAsset(L)},onShot:function(L){var F=gEngine.ResourceMap.retrieveAsset(L);if(null!==F){var P=t.createBufferSource();P.buffer=F,P.connect(t.destination),P.start(0)}},playBackgroundAudio:function(L){var F=gEngine.ResourceMap.retrieveAsset(L);null!==F&&(f(),o=t.createBufferSource(),o.buffer=F,o.connect(t.destination),o.loop=!0,o.start(0))},stopBackgroundAudio:f,isBackgroundAudioPlaying:function(){return null!==o},pause:function(){t.suspend()},resume:function(){t.resume()}}}(),gEngine.Textures=function(){function t(C,f,T,S){this.mName=C,this.mWidth=f,this.mHeight=T,this.mGLTexID=S}var n=function(C,f){var T=gEngine.Core.getGL(),S=T.createTexture();T.bindTexture(T.TEXTURE_2D,S),T.texImage2D(T.TEXTURE_2D,0,T.RGBA,T.RGBA,T.UNSIGNED_BYTE,f),T.generateMipmap(T.TEXTURE_2D),T.bindTexture(T.TEXTURE_2D,null);var L=new t(C,f.naturalWidth,f.naturalHeight,S);gEngine.ResourceMap.asyncLoadCompleted(C,L)};return{loadTexture:function(C){if(!gEngine.ResourceMap.isAssetLoaded(C)){var f=new Image;gEngine.ResourceMap.asyncLoadRequested(C),f.onload=function(){n(C,f)},f.src=C}else gEngine.ResourceMap.incAssetRefCount(C)},unloadTexture:function(C){var f=gEngine.Core.getGL(),T=gEngine.ResourceMap.retrieveAsset(C);f.deleteTexture(T.mGLTexID),gEngine.ResourceMap.unloadAsset(C)},activateTexture:function(C){var f=gEngine.Core.getGL(),T=gEngine.ResourceMap.retrieveAsset(C);f.bindTexture(f.TEXTURE_2D,T.mGLTexID),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST)},deactivateTexture:function(){var C=gEngine.Core.getGL();C.bindTexture(C.TEXTURE_2D,null)},getTextureInfo:function(C){return gEngine.ResourceMap.retrieveAsset(C)}}}(),gEngine.Fonts=function(){function t(){this.mTexCoordLeft=0,this.mTexCoordRight=1,this.mTexCoordBottom=0,this.mTexCoordTop=0,this.mCharWidth=1,this.mCharHeight=1,this.mCharWidthOffset=0,this.mCharHeightOffset=0,this.mCharAspectRatio=1}var a=function(u){var g=u.slice(0,-4),C=gEngine.ResourceMap.retrieveAsset(u);C.FontImage=g+'.png',gEngine.ResourceMap.asyncLoadCompleted(g,C)};return{loadFont:function(u){if(!gEngine.ResourceMap.isAssetLoaded(u)){gEngine.ResourceMap.asyncLoadRequested(u),gEngine.Textures.loadTexture(u+'.png'),gEngine.TextFileLoader.loadTextFile(u+'.fnt',gEngine.TextFileLoader.TextFileType.XMLFile,a)}else gEngine.ResourceMap.incAssetRefCount(u)},unloadFont:function(u){if(gEngine.ResourceMap.unloadAsset(u),!gEngine.ResourceMap.isAssetLoaded(u)){gEngine.Textures.unloadTexture(u+'.png'),gEngine.TextFileLoader.unloadTextFile(u+'.fnt')}},getCharInfo:function(u,g){var C=null,f=gEngine.ResourceMap.retrieveAsset(u),S=f.evaluate('font/common',f,null,XPathResult.ANY_TYPE,null);if(S=S.iterateNext(),null===S)return C;var L=S.getAttribute('base'),P=f.evaluate('font/chars/char[@id='+g+']',f,null,XPathResult.ANY_TYPE,null);if(P=P.iterateNext(),null===P)return C;C=new t;var R=gEngine.Textures.getTextureInfo(f.FontImage),A=+P.getAttribute('x'),V=A+ +P.getAttribute('width')-1,B=+P.getAttribute('y'),I=B+ +P.getAttribute('height');C.mTexCoordLeft=A/(R.mWidth-1),C.mTexCoordTop=B/(R.mHeight-1),C.mTexCoordRight=V/(R.mWidth-1),C.mTexCoordBottom=I/(R.mHeight-1);var D=P.getAttribute('xadvance');return C.mCharWidth=P.getAttribute('width')/D,C.mCharHeight=P.getAttribute('height')/L,C.mCharWidthOffset=P.getAttribute('xoffset')/D,C.mCharHeightOffset=P.getAttribute('yoffset')/L,C.mCharAspectRatio=D/L,C}}}(),gEngine.Physics=function(){var t=null;return{initialize:function(){Matter.use('matter-collision-events'),t=Matter.Engine.create(),t.world.gravity.scale=-1},update:function(T=1){Matter.Engine.update(t,T)},getEngine:function(){return t},getWorld:function(){return t.world},cleanUp:function(){}}}();function Interpolate(t,o,a){this.mCurrentValue=t,this.mFinalValue=t,this.mCycles=o,this.mRate=a,this.mCyclesLeft=0}Interpolate.prototype.interpolateValue=function(){this.mCurrentValue+=this.mRate*(this.mFinalValue-this.mCurrentValue)},Interpolate.prototype.getValue=function(){return this.mCurrentValue},Interpolate.prototype.configInterpolation=function(t,o){this.mRate=t,this.mCycles=o},Interpolate.prototype.setFinalValue=function(t){this.mFinalValue=t,this.mCyclesLeft-this.mCycles},Interpolate.prototype.updateInterpolation=function(){0>=this.mCyclesLeft||(this.mCycles--,0===this.mCyclesLeft?this.mCurrentValue=this.mFinalValue:this.interpolateValue())};function InterpolateVec2(t,o,a){Interpolate.call(this,t,o,a)}gEngine.Core.inheritPrototype(InterpolateVec2,Interpolate),InterpolateVec2.prototype.interpolateValue=function(){twgl.v3.lerp(this.mCurrentValue,this.mFinalValue,this.mRate,this.mCurrentValue)};function Shake(t,o,a,n){this.mXMag=t,this.mYMag=o,this.mCycles=n,this.mOmega=2*a*Math.PI,this.mNumCyclesLeft=n}Shake.prototype.nextDampedHarmonic=function(){let t=this.mNumCyclesLeft/this.mCycles;return t*t*Math.cos((1-t)*this.mOmega)},Shake.prototype.shakeDone=function(){return 0>=this.mNumCyclesLeft},Shake.prototype.getShakeResults=function(){this.mNumCyclesLeft--;let t=[],o=0,a=0;if(!this.shakeDone()){let n=this.nextDampedHarmonic();o=0.5<Math.random()?-n:n,a=0.5<Math.random()?-n:n}return t[0]=this.mXMag*o,t[1]=this.mYMag*a,t};function SimpleShader(t,o){this.mCompiledShader=null;var a=gEngine.Core.getGL(),n=gEngine.ResourceMap.retrieveAsset(t),m=gEngine.ResourceMap.retrieveAsset(o);this.mCompiledShader=twgl.createProgramInfo(a,[n,m]),this.mUniforms={u_color:null,u_transform:null,u_viewTransform:null,u_globalAmbientColor:null,u_globalAmbientIntensity:null},this.mCompiledShader||console.log('shader compilation error')}SimpleShader.prototype.activateShader=function(t,o,a){var n=gEngine.Core.getGL();n.useProgram(this.mCompiledShader.program),twgl.setBuffersAndAttributes(n,this.mCompiledShader,gEngine.VertexBuffer.getVertexBuffer());let m=a.getViewport();this.mUniforms={u_globalAmbientColor:gEngine.DefaultResources.getGlobalAmbientColor(),u_globalAmbientIntensity:gEngine.DefaultResources.getGlobalAmbientIntensity(),u_color:t,u_screenSize:[m[2],m[3]],u_transform:o,u_viewTransform:a.getVPMatrix()},twgl.setUniforms(this.mCompiledShader,this.mUniforms)},SimpleShader.prototype.getShader=function(){return this.mCompiledShader},SimpleShader.prototype.cleanUp=function(){var t=gEngine.Core.getGL();t.deleteProgram(this.mCompiledShader.program)};function TextureShader(t,o){SimpleShader.call(this,t,o)}gEngine.Core.inheritPrototype(TextureShader,SimpleShader),TextureShader.prototype.activateShader=function(t,o,a){SimpleShader.prototype.activateShader.call(this,t,o,a)};function SpriteShader(t,o){var a=gEngine.Core.getGL();this.mTextureCoord=[1,0,0,0,1,1,0,1],this.mTexCoordBuffer=twgl.createBufferInfoFromArrays(a,{textureCoordinate:{data:this.mTextureCoord,numComponents:2,drawType:a.DYNAMIC_DRAW}}),TextureShader.call(this,t,o)}gEngine.Core.inheritPrototype(SpriteShader,TextureShader),SpriteShader.prototype.setTextureCoord=function(t){this.mTextureCoord=t},SpriteShader.prototype.cleanUp=function(){var t=gEngine.Core.getGL();t.deleteBuffer(this.mTexCoordBuffer.attribs.textureCoordinate.buffer),SimpleShader.prototype.cleanUp.call(this)},SpriteShader.prototype.activateShader=function(t,o,a){SimpleShader.prototype.activateShader.call(this,t,o,a);var n=gEngine.Core.getGL();twgl.setAttribInfoBufferFromArray(n,this.mTexCoordBuffer.attribs.textureCoordinate,this.mTextureCoord),twgl.setBuffersAndAttributes(n,this.mCompiledShader,this.mTexCoordBuffer)};function LightShader(t,o){SpriteShader.call(this,t,o),this.mLights=null,this.kGLSLuLightArraySize=4}gEngine.Core.inheritPrototype(LightShader,SpriteShader),LightShader.prototype.setLights=function(t){this.mLights=t},LightShader.prototype.getLightOff=function(t,o){t['u_lights['+o+'].IsOn']=!1},LightShader.prototype.getLightInfo=function(t,o,a){if(this.mLights[a].getLightStatus()){let n=o.worldToPixel(this.mLights[a].getPosition());t['u_lights['+a+'].Position']=[n[0],n[1],n[2],1],t['u_lights['+a+'].Color']=this.mLights[a].getColor(),t['u_lights['+a+'].Near']=o.sizeToPixel(this.mLights[a].getNear()),t['u_lights['+a+'].Far']=o.sizeToPixel(this.mLights[a].getFar()),t['u_lights['+a+'].Intensity']=this.mLights[a].getIntensity(),t['u_lights['+a+'].IsOn']=!0}else this.getLightOff(t,a)},LightShader.prototype.activateShader=function(t,o,a){SpriteShader.prototype.activateShader.call(this,t,o,a);var m=0;if(null!==this.mLights)for(;m<this.mLights.length;)this.getLightInfo(this.mUniforms,a,m),m++;for(;m<this.kGLSLuLightArraySize;)this.getLightOff(this.mUniforms,m),m++;twgl.setUniforms(this.mCompiledShader,this.mUniforms)};var AnimationState=Object.freeze({Paused:0,Playing:1,Ended:0}),AnimationOperator=Object.freeze({Equals:0,MoreThan:1,LessThan:2});function FrameDescriptor(t){if(this.mFrames=void 0,t.frames)this.mFrames=t.frames;else{this.mFrames=[];for(let o=0,a=0;o<t.imageHeight&&a<t.numFrames;o+=t.height)for(let n=0;n<t.imageWidth-t.width&&a<t.numFrames;n+=t.width,a++)this.mFrames.push([n,o,n+t.width,o+t.height])}}FrameDescriptor.prototype.getFrame=function(t){return this.mFrames[t]};function AnimationDescription(t){this.mDirection=t.direction||1,t.frames?(this.mLimit=t.frames.length,this.mStart=0,this.mFrameIndexes=t.frames):(this.mStart=t.start,this.mLimit=t.start+t.count),this.mTime=t.time,this.mCurrentTime=0,this.mCurrentFrame=this.mStart,this.mLoops=t.loops||1,this.mCurrentLoops=0,this.mState=AnimationState.Playing,this.mSpeed=t.speed||1}AnimationDescription.prototype.reset=function(){this.mCurrentLoops=0,this.mCurrentTime=0,this.mCurrentAnimation=this.mStart,this.mState=AnimationState.Playing},AnimationDescription.prototype.update=function(t){(this.mCurrentLoops<this.mLoops||0>this.mLoops)&&(this.mCurrentTime+=t*this.mSpeed,this.mCurrentTime>=this.mTime&&(this.mCurrentTime=0,this.mCurrentFrame+=this.mDirection,this.mCurrentFrame>=this.mLimit&&(this.mCurrentLoops<this.mLoops-1||0>this.mLoops?this.mCurrentFrame=this.mStart:(this.mCurrentFrame-=this.mDirection,this.mState=AnimationState.Ended),this.mCurrentLoops++)))},AnimationDescription.prototype.getFrame=function(){return this.mFrameIndexes?this.mFrameIndexes[this.mCurrentFrame]:this.mCurrentFrame};function AnimationParam(t,o){this.mName=t,this.mType=o}function Condition(t,o,a){this.mName=t,this.mOperador=o,this.mValue=a}Condition.prototype.test=function(t){switch(this.mOperador){case AnimationOperator.Equals:return this.mValue==t;case AnimationOperator.MoreThan:return t>this.mValue;case AnimationOperator.LessThan:return t<this.mValue;}};function Transition(t,o){this.mDest=t,this.mConditions=o}function AnimationController(t){this.mParams=t.params||[],this.mAnimations=t.animations||[],this.mDefaultAnimation=t.defaultAnimation||0,this.mCurrentAnimation=this.mDefaultAnimation,this.mTransitions=t.transitions||[]}AnimationController.prototype.update=function(t){if(this.mTransitions[this.mCurrentAnimation]){let o=this.mTransitions[this.mCurrentAnimation];for(let a=0,n=o.length,m=!0;a<n;a++){if(!!o[a].mConditions){for(let d=0,u=o[a].mConditions.length;d<u;d++)if(void 0==this.mParams[o[a].mConditions[d].mName])console.warn('No animation param called '+o[a].mConditions[d].mName);else if(!o[a].mConditions[d].test(this.mParams[o[a].mConditions[d].mName])){m=!1;break}}else if(this.mAnimations[this.mCurrentAnimation].mState!=AnimationState.Ended){m=!1;break}if(m){this.mCurrentAnimation=o[a].mDest,this.mAnimations[this.mCurrentAnimation].reset();break}}}this.mAnimations[this.mCurrentAnimation]&&this.mAnimations[this.mCurrentAnimation].update(t)},AnimationController.prototype.getFrame=function(){return this.mAnimations[this.mCurrentAnimation].getFrame()},AnimationController.prototype.setParamValue=function(t,o){this.mParams[t]=o};function Animator(t){this.mAnimationController=null,this.mFrames=null,this.mFrameInfo=null,t?(this.mAnimationController=new AnimationController({params:t.params||{},animations:t.animations||[new AnimationDescription({frames:[0],time:300,loops:-1})],defaultAnimation:t.defaultAnimation||0,transitions:t.transitions}),(t.frames||t.frame)&&(this.mFrameInfo={frames:t.frames,width:t.frame.width,height:t.frame.height,numFrames:t.frame.count})):this.mAnimationController=new AnimationController({params:{},animations:[new AnimationDescription({frames:[0],time:300,loops:-1})],defaultAnimation:0,transitions:[]}),this.mPrevFrame=-1,this.mParent=null}Animator.prototype.setUpTexture=function(){let t=gEngine.Textures.getTextureInfo(this.mParent.renderer.getTexture());this.mFrameInfo?(this.mFrameInfo.imageWidth=t.mWidth,this.mFrameInfo.imageHeight=t.mHeight):this.mFrameInfo={frames:[[0,0,t.mWidth,t.mHeight]]},this.mFrames=new FrameDescriptor(this.mFrameInfo);let o=this.mAnimationController.getFrame();if(o!=this.mPrevFrame){let a=this.mFrames.getFrame(o);this.mPrevFrame=o,this.mParent.renderer.setTextureCoordPixels(a[0],a[2],a[3],a[1])}},Animator.prototype.setParent=function(t){this.mParent=t,this.setUpTexture()},Animator.prototype.update=function(t=10){this.mAnimationController.update(t);let o=this.mAnimationController.getFrame(),a=this.mFrames.getFrame(o);a!=this.mPrevFrame&&(this.mPrevFrame=a,this.mParent.renderer.setTextureCoordPixels(a[0],a[2],a[3],a[1]))},Animator.prototype.setParamValue=function(t,o){this.mAnimationController.setParamValue(t,o)};function Physics(t){this.mBody=null,this.mParent=null,this.mOptions=t||{inertia:Infinity}}Physics.prototype.setParent=function(t){this.mParent=t;let o=this.mParent.transform;this.mBody=Matter.Bodies.rectangle(0,0,0.95,0.95,this.mOptions),Matter.Body.scale(this.mBody,o.getScaleX(),o.getScaleY(),{x:0,y:0}),Matter.Body.rotate(this.mBody,o.getRotation(),{x:0,y:0}),Matter.Body.setPosition(this.mBody,{x:o.getPositionX(),y:o.getPositionY()}),this.mBody.render=this.mParent.renderer,this.mBody.onCollide(this.mParent.onCollisionStart.bind(this.mParent)),this.mBody.onCollideEnd(this.mParent.onCollisionEnd.bind(this.mParent)),Matter.World.add(gEngine.Physics.getWorld(),this.mBody)},Physics.prototype.getBody=function(){return this.mBody},Physics.prototype.update=function(){this.mParent.transform.setPositionX(this.mBody.position.x),this.mParent.transform.setPositionY(this.mBody.position.y),this.mParent.transform.setRotation(this.mBody.angle)},Physics.prototype.applyForce=function(t){Matter.Body.applyForce(this.mBody,{x:this.mParent.transform.getPositionX(),y:this.mParent.transform.getPositionY()},t)};function Transform(){this.mPosition=twgl.v3.create(0,0,0),this.mScale=twgl.v3.create(1,1,1),this.mRotation=0}Transform.prototype.setRotation=function(t){this.mRotation=t},Transform.prototype.setRotationDeg=function(t){this.mRotation=0.01745329251*t},Transform.prototype.setPosition=function(t){this.mPosition=t},Transform.prototype.setPositionX=function(t){this.mPosition[0]=t},Transform.prototype.setPositionY=function(t){this.mPosition[1]=t},Transform.prototype.setPositionZ=function(t){this.mPosition[2]=t},Transform.prototype.setScale=function(t){this.mScale=t},Transform.prototype.setScaleX=function(t){this.mScale[0]=t},Transform.prototype.setScaleY=function(t){this.mScale[1]=t},Transform.prototype.setScaleZ=function(t){this.mScale[2]=t},Transform.prototype.translate=function(t){this.mPosition[0]+=t[0],this.mPosition[1]+=t[1],this.mPosition[2]+=t[2]},Transform.prototype.translateX=function(t){this.mPosition[0]+=t},Transform.prototype.translateY=function(t){this.mPosition[1]+=t},Transform.prototype.translateZ=function(t){this.mPosition[2]+=t},Transform.prototype.scale=function(t){this.mScale[0]+=t[0],this.mScale[1]+=t[1],this.mScale[2]+=t[2]},Transform.prototype.scaleX=function(t){this.mScale[0]+=t},Transform.prototype.scaleY=function(t){this.mScale[1]+=t},Transform.prototype.scaleZ=function(t){this.mScale[2]+=t},Transform.prototype.rotate=function(t){this.mRotation+=t},Transform.prototype.getRotation=function(){return this.mRotation},Transform.prototype.getRotationDeg=function(){return 57.2957795131*this.mRotation},Transform.prototype.getPosition=function(){return this.mPosition},Transform.prototype.getPositionX=function(){return this.mPosition[0]},Transform.prototype.getPositionY=function(){return this.mPosition[1]},Transform.prototype.getPositionZ=function(){return this.mPosition[2]},Transform.prototype.getScale=function(){return this.mScale},Transform.prototype.getScaleX=function(){return this.mScale[0]},Transform.prototype.getScaleY=function(){return this.mScale[1]},Transform.prototype.getScaleZ=function(){return this.mScale[2]},Transform.prototype.getMatrix=function(){var t=twgl.m4.identity();return twgl.m4.setTranslation(t,this.mPosition,t),twgl.m4.rotateZ(t,this.mRotation,t),twgl.m4.scale(t,this.mScale,t),t};function Scene(){}Scene.prototype.constructor=function(){},Scene.prototype.initialize=function(){},Scene.prototype.loadScene=function(){},Scene.prototype.unloadScene=function(){},Scene.prototype.update=function(){},Scene.prototype.draw=function(){};function PerRenderCache(){this.mWorldToPixelRatio=1,this.mCameraOriginX=1,this.mCameraOriginY=1}function CameraState(t,o){this.kCycles=300,this.kRate=1,this.mCenter=new InterpolateVec2(t,this.kCycles,this.kRate),this.mWidth=new Interpolate(o,this.kCycles,this.kRate)}CameraState.prototype.getCenter=function(){return this.mCenter.getValue()},CameraState.prototype.getWidth=function(){return this.mWidth.getValue()},CameraState.prototype.setWidth=function(t){return this.mWidth.setFinalValue(t)},CameraState.prototype.setCenter=function(t){return this.mCenter.setFinalValue(t)},CameraState.prototype.updateCameraState=function(){this.mCenter.updateInterpolation(),this.mWidth.updateInterpolation()},CameraState.prototype.configInterpolation=function(t,o){this.mCenter.configInterpolation(t,o),this.mWidth.configInterpolation(t,o)};function Camera(t,o,a,n){this.mCameraState=new CameraState(t,o),this.mCameraShake=null,this.mRenderCache=new PerRenderCache,this.mViewport=[],this.mViewportBound=0,n!==void 0&&(this.mViewportBound=n),this.mScissorBound=[],this.setViewPort(a||[0,0,1,1],this.mViewportBound),this.mFarPlane=1e3,this.mNearPlane=0,this.mViewMatrix=twgl.m4.identity(),this.mProjMatrix=twgl.m4.identity(),this.mVPMatrix=twgl.m4.identity(),this.mBgColor=[0,0,0,1]}Camera.prototype.getBackgroundColor=function(){return this.mBgColor},Camera.prototype.getCenter=function(){return this.mCameraState.getCenter()},Camera.prototype.getWidth=function(){return this.mCameraState.getWidth()},Camera.prototype.getHeight=function(){return this.mCameraState.getWidth()*this.mViewport[3]/this.mViewport[2]},Camera.prototype.getVPMatrix=function(){return this.mVPMatrix},Camera.prototype.getViewport=function(){return[this.mViewport[0],this.mViewport[1],this.mViewport[2],this.mViewport[3]]},Camera.prototype.getViewportScale=function(){return[this.mScissorBound[0],this.mScissorBound[1],this.mScissorBound[2],this.mScissorBound[3]]},Camera.prototype.setBackgroundColor=function(t){this.mBgColor=t},Camera.prototype.setWidth=function(t){this.mCameraState.setWidth(t)},Camera.prototype.setCenter=function(t,o){this.mCameraState.setCenter([t,o,0])},Camera.prototype.setViewPort=function(t,o){let a=gEngine.Core.getGL();o===void 0&&(o=this.mViewportBound),this.mViewPortFactor=t,this.mViewport[0]=a.canvas.width*this.mViewPortFactor[0]+o,this.mViewport[1]=a.canvas.height*this.mViewPortFactor[1]+o,this.mViewport[2]=a.canvas.width*this.mViewPortFactor[2]-2*o,this.mViewport[3]=a.canvas.height*this.mViewPortFactor[3]-2*o,this.mScissorBound[0]=a.canvas.width*this.mViewPortFactor[0],this.mScissorBound[1]=a.canvas.height*this.mViewPortFactor[1],this.mScissorBound[2]=a.canvas.width*this.mViewPortFactor[2],this.mScissorBound[3]=a.canvas.height*this.mViewPortFactor[3]},Camera.prototype.refreshViewport=function(){let t=gEngine.Core.getGL();this.mViewport[0]=t.canvas.width*this.mViewPortFactor[0]+this.mViewportBound,this.mViewport[1]=t.canvas.height*this.mViewPortFactor[1]+this.mViewportBound,this.mViewport[2]=t.canvas.width*this.mViewPortFactor[2]-2*this.mViewportBound,this.mViewport[3]=t.canvas.height*this.mViewPortFactor[3]-2*this.mViewportBound,this.mScissorBound[0]=t.canvas.width*this.mViewPortFactor[0],this.mScissorBound[1]=t.canvas.height*this.mViewPortFactor[1],this.mScissorBound[2]=t.canvas.width*this.mViewPortFactor[2],this.mScissorBound[3]=t.canvas.height*this.mViewPortFactor[3]},Camera.prototype.shake=function(t,o,a,n){this.mCameraShake=new CameraShake(this.mCameraState,t,o,a,n)},Camera.prototype.update=function(){null!==this.mCameraShake&&(this.mCameraShake.shakeDone()?this.mCameraShake=null:(this.mCameraShake.setRefCenter(this.getCenter()),this.mCameraShake.updateShakeState())),this.mCameraState.updateCameraState()},Camera.prototype.mouseDCX=function(){return gEngine.Input.getMousePosX()-this.mViewport[0]},Camera.prototype.mouseDCY=function(){return gEngine.Input.getMousePosY()-this.mViewport[1]},Camera.prototype.mouseDC=function(){return[gEngine.Input.getMousePosX()-this.mViewport[0],gEngine.Input.getMousePosY()-this.mViewport[1]]},Camera.prototype.mouseWCX=function(){let t=this.getCenter()[0]-this.getWidth()/2;return t+this.mouseDCX()*(this.getWidth()/this.mViewport[2])},Camera.prototype.mouseWCY=function(){let t=this.getCenter()[1]-this.getHeight()/2;return t+this.mouseDCY()*(this.getHeight()/this.mViewport[3])},Camera.prototype.screenToSpace=function(t){let o=this.getCenter()[1]-this.getHeight()/2,a=this.getCenter()[0]-this.getWidth()/2;return[a+(t[0]-this.mViewport[0])*(this.getWidth()/this.mViewport[2]),o+(this.mViewport[3]-t[1]-this.mViewport[1])*(this.getHeight()/this.mViewport[3])]},Camera.prototype.mouseWC=function(){let t=this.getCenter()[1]-this.getHeight()/2,o=this.getCenter()[0]-this.getWidth()/2;return[o+this.mouseDCX()*(this.getWidth()/this.mViewport[2]),t+this.mouseDCY()*(this.getHeight()/this.mViewport[3])]},Camera.prototype.isMouseInViewport=function(){let t=this.mouseDC();return 0<=t[0]&&t[0]<this.mViewport[2]&&0<=t[1]&&t[1]<this.mViewport[3]},Camera.prototype.configInterpolation=function(t,o){this.mCameraState.configInterpolation(t,o)},Camera.prototype.setupViewProjection=function(){var t=gEngine.Core.getGL();this.mRenderCache.mWorldToPixelRatio=this.mViewport[2]/this.getWidth(),this.mRenderCache.mCameraOriginX=this.getCenter()[0]-this.getWidth()/2,this.mRenderCache.mCameraOriginY=this.getCenter()[1]-this.getHeight()/2,t.viewport(this.mViewport[0],this.mViewport[1],this.mViewport[2],this.mViewport[3]),t.clearColor(0,0,0,0),t.scissor(this.mScissorBound[0],this.mScissorBound[1],this.mScissorBound[2],this.mScissorBound[3]),t.clearColor(this.mBgColor[0],this.mBgColor[1],this.mBgColor[2],this.mBgColor[3]),t.enable(t.SCISSOR_TEST),t.clear(t.COLOR_BUFFER_BIT),t.disable(t.SCISSOR_TEST);let o=[];o=null===this.mCameraShake?this.getCenter():this.mCameraShake.getCenter();var a=0.5*this.getWidth(),n=0.5*this.getHeight();twgl.m4.lookAt([o[0],o[1],10],[o[0],o[1],0],[0,1,0],this.mViewMatrix),twgl.m4.ortho(-a,a,-n,n,this.mNearPlane,this.mFarPlane,this.mProjMatrix),twgl.m4.inverse(this.mViewMatrix,this.mViewMatrix),twgl.m4.multiply(this.mProjMatrix,this.mViewMatrix,this.mVPMatrix)},Camera.prototype.fakeZInPixelSpace=function(t){return t*this.mRenderCache.mWorldToPixelRatio},Camera.prototype.worldToPixel=function(t){let o=this.mViewport[0]+(t[0]-this.mRenderCache.mCameraOriginX)*this.mRenderCache.mWorldToPixelRatio+0.5,a=this.mViewport[1]+(t[1]-this.mRenderCache.mCameraOriginY)*this.mRenderCache.mWorldToPixelRatio+0.5,n=this.fakeZInPixelSpace(t[2]);return[o,a,n]},Camera.prototype.sizeToPixel=function(t){return t*this.mRenderCache.mWorldToPixelRatio+0.5};function CameraShake(t,o,a,n,m){this.mOrgCenter=twgl.v3.copy(t.getCenter()),this.mShakeCenter=twgl.v3.copy(this.mOrgCenter),this.mShake=new Shake(o,a,n,m)}CameraShake.prototype.updateShakeState=function(){var t=this.mShake.getShakeResults();twgl.v3.add(this.mOrgCenter,t,this.mShakeCenter)},CameraShake.prototype.shakeDone=function(){return this.mShake.shakeDone()},CameraShake.prototype.getCenter=function(){return this.mShakeCenter},CameraShake.prototype.setRefCenter=function(t){this.mOrgCenter[0]=t[0],this.mOrgCenter[1]=t[1]};function Light(){this.mColor=[1,1,1,1],this.mPosition=[0,0,5],this.mNear=5,this.mFar=12,this.mIntensity=1,this.mIsOn=!0}Light.prototype.setColor=function(t){this.mColor=t},Light.prototype.setPosition=function(t){this.mPosition=[t[0],t[1],this.mPosition[2]]},Light.prototype.setPositionX=function(t){this.mPosition[0]=t},Light.prototype.setPositionY=function(t){this.mPosition[1]=t},Light.prototype.setPositionZ=function(t){this.mPosition[2]=t},Light.prototype.setLightStatus=function(t){this.mIsOn=t},Light.prototype.setNear=function(t){this.mNear=t},Light.prototype.setFar=function(t){this.mFar=t},Light.prototype.setIntensity=function(t){this.mIntensity=t},Light.prototype.getIntensity=function(){return this.mIntensity},Light.prototype.getFar=function(){return this.mFar},Light.prototype.getNear=function(){return this.mNear},Light.prototype.getColor=function(){return this.mColor},Light.prototype.getPosition=function(){return this.mPosition},Light.prototype.getLightStatus=function(){return this.mIsOn};function LightSet(){this.mSet=[]}LightSet.prototype.getCount=function(){return this.mSet.length},LightSet.prototype.getLightAt=function(t){return this.mSet[t]},LightSet.prototype.Add=function(t){this.mSet.push(t)};let ComponetType=Object.freeze({transform:'Transform',renderer:'Renderer',physics:'Physics'});function GameObject(){this.mComponents={},this.addComponent(new Transform),this.addComponent(new Renderer),this.mParent=null,this.mChildren=null}GameObject.prototype.update=function(t=1){for(let o in this.mComponents)this.mComponents[o].update&&this.mComponents[o].update(t)},GameObject.prototype.draw=function(t){for(let o in this.mComponents)this.mComponents[o].draw&&this.mComponents[o].draw(t)},GameObject.prototype.addComponent=function(t){this.mComponents[t.constructor.name]=t,this.mComponents[t.constructor.name].setParent&&this.mComponents[t.constructor.name].setParent(this),Object.defineProperty(this,t.constructor.name.replace(/^\w/,o=>o.toLowerCase()),{get:function(){return this.mComponents[t.constructor.name]}})},GameObject.prototype.getComponent=function(t){return this.mComponents[t]},GameObject.prototype.getAllComponents=function(){console.log(this.mComponents)},GameObject.prototype.destroy=function(){},GameObject.prototype.setComponent=function(t,o){this.mComponents[t]?(this.mComponents[t]=o,this.mComponents[t].setParent&&this.mComponents[t].setParent(this)):this.addComponent(o)},GameObject.prototype.onCollisionStart=function(){},GameObject.prototype.onCollisionEnd=function(){};function Renderer(){this.mShader=gEngine.DefaultResources.getColorShader(),this.mColor=[1,1,1,1],this.mParent=null}Renderer.prototype.setParent=function(t){this.mParent=t},Renderer.prototype.draw=function(t){var o=gEngine.Core.getGL();this.mShader.activateShader(this.mColor,this.mParent.transform.getMatrix(),t),twgl.drawBufferInfo(o,gEngine.VertexBuffer.getVertexBuffer(),o.TRIANGLE_STRIP)},Renderer.prototype.setShader=function(t){this.mShader=t},Renderer.prototype.getLightAt=function(){},Renderer.prototype.addLight=function(){},Renderer.prototype.setColor=function(t){this.mColor=t},Renderer.prototype.getColor=function(){return this.mColor};function TextureRenderer(t){Renderer.call(this),Renderer.prototype.setShader.call(this,gEngine.DefaultResources.getTextureShader()),this.mTexture=t}gEngine.Core.inheritPrototype(TextureRenderer,Renderer),TextureRenderer.prototype.draw=function(t){gEngine.Textures.activateTexture(this.mTexture),Renderer.prototype.draw.call(this,t)},TextureRenderer.prototype.getTexture=function(){return this.mTexture},TextureRenderer.prototype.setTexture=function(t){this.mTexture=t};function SpriteRenderer(t){TextureRenderer.call(this,t),Renderer.prototype.setShader.call(this,gEngine.DefaultResources.getSpriteShader()),this.mTexLeft=0,this.mTexRight=1,this.mTexTop=0,this.mTexBottom=1}gEngine.Core.inheritPrototype(SpriteRenderer,TextureRenderer),SpriteRenderer.prototype.draw=function(t){this.setUVCoords(),TextureRenderer.prototype.draw.call(this,t)},SpriteRenderer.prototype.setTextureCoordUV=function(t,o,a,n){this.mTexLeft=t,this.mTexRight=o,this.mTexBottom=a,this.mTexTop=n},SpriteRenderer.prototype.setTextureCoordPixels=function(t,o,a,n){var m=gEngine.ResourceMap.retrieveAsset(this.mTexture),d=m.mWidth,u=m.mHeight;this.mTexLeft=t/d,this.mTexRight=o/d,this.mTexBottom=a/u,this.mTexTop=n/u},SpriteRenderer.prototype.setUVCoords=function(){this.mShader.setTextureCoord([this.mTexRight,this.mTexTop,this.mTexLeft,this.mTexTop,this.mTexRight,this.mTexBottom,this.mTexLeft,this.mTexBottom])},SpriteRenderer.TexCoord=Object.freeze({Left:2,Right:0,Top:1,Bottom:5});function LightRenderer(t){SpriteRenderer.call(this,t),Renderer.prototype.setShader.call(this,gEngine.DefaultResources.getLightShader()),this.mLights=[]}gEngine.Core.inheritPrototype(LightRenderer,SpriteRenderer),LightRenderer.prototype.draw=function(t){this.mShader.setLights(this.mLights),SpriteRenderer.prototype.draw.call(this,t)},LightRenderer.prototype.getLightAt=function(t){return this.mLights[t]},LightRenderer.prototype.addLight=function(t){this.mLights.push(t)};function Tileset(t,o){this.mTexture=t,this.mColumns=o.columns,this.mFirstId=o.firstgid,this.mImageHeight=o.imageheight,this.mImageWidth=o.imagewidth,this.mMargin=o.margin,this.mSpacing=o.spacing,this.mTileCount=o.tilecount,this.mTileHeight=o.tileheight,this.mTileWidth=o.tilewidth,this.mHeight=o.imageheight/o.tileheight,this.mWidth=o.imagewidth/o.tilewidth,this.mInverseWidth=1/o.tilewidth,this.mInverseHeight=1/o.tileheight,this.mOffset=3e-3}Tileset.prototype.getCoords=function(t){if(0<t&&t<this.mTileCount){let o=(t-1)%this.mWidth,a=Math.floor((t-1)/this.mWidth);return[o*this.mInverseWidth+this.mOffset,(o+1)*this.mInverseWidth-this.mOffset,a*this.mInverseHeight+this.mOffset,(a+1)*this.mInverseHeight-this.mOffset]}},Tileset.prototype.getTexture=function(){return this.mTexture};function MapLayer(t,o,a){this.mShader=a||gEngine.DefaultResources.getSpriteShader(),this.mTilesets=o,this.mData=t,this.mBufferInfo=null,this.mTint=[1,1,1,this.mData.opacity],this.mArrays={position:{numComponents:3,data:[]},indices:{numComponents:3,data:[]},textureCoordinate:{numComponents:2,data:[]}};let n=-(.5*this.mData.width),m=0.5*this.mData.height;for(let u=0,g=0;u<this.mData.height;u++)for(let C=this.mData.width*u,f=0;f<this.mData.width;C++,f++)if(0<this.mData.data[C]){this.mArrays.position.data.push(n+f,m-(u+1),0,n+f,m-u,0,n+(f+1),m-u,0,n+(f+1),m-(u+1),0),this.mArrays.indices.data.push(g+3,g+2,g+1,g+3,g+1,g);let T=this.mTilesets[0].getCoords(this.mData.data[C]);this.mArrays.textureCoordinate.data.push(T[0],T[3],T[0],T[2],T[1],T[2],T[1],T[3]),g+=4}var d=gEngine.Core.getGL();this.mBufferInfo=twgl.createBufferInfoFromArrays(d,this.mArrays)}MapLayer.prototype.setShader=function(t){this.mShader=t},MapLayer.prototype.draw=function(t,o,a){let n=gEngine.Core.getGL();this.mShader.setLights&&this.mShader.setLights(a),this.mShader.activateShader(this.mTint,t,o),twgl.setBuffersAndAttributes(n,this.mShader.getShader(),this.mBufferInfo),gEngine.Textures.activateTexture(this.mTilesets[0].mTexture),twgl.drawBufferInfo(n,this.mBufferInfo)};function MapRenderer(t){this.mLayers=[],this.mMapName=t,this.mData=[],this.mTilesets=[],this.mTransform=new Transform,this.mLights=[],this.mShader=gEngine.DefaultResources.getSpriteShader(),this.mComposites=[]}MapRenderer.prototype.load=function(){gEngine.TextFileLoader.loadTextFile(this.mMapName,gEngine.TextFileLoader.TextFileType.TextFile,function(t){if(this.mData=JSON.parse(gEngine.ResourceMap.retrieveAsset(t)),this.mData)for(var o in this.mData.tilesets){let a=this.mMapName.substr(0,this.mMapName.lastIndexOf('/')+1)+this.mData.tilesets[o].image,n=new Tileset(a,this.mData.tilesets[o]);this.mTilesets.push(n)}}.bind(this))},MapRenderer.prototype.createBody=function(t){let o=gEngine.Physics.getWorld(),a=0.5*-this.mData.width,n=0.5*this.mData.height,m=Matter.Composite.create();for(let d in t.objects){let u=t.objects[d].width/this.mData.tilewidth,g=t.objects[d].height/this.mData.tileheight,C=t.objects[d].x/this.mData.tilewidth+0.5*u,f=this.mData.height-t.objects[d].y/this.mData.tileheight-0.5*g;Matter.Composite.add(m,Matter.Bodies.rectangle(C,f,u,g,{isStatic:!0}))}Matter.Composite.translate(m,{x:a,y:-n}),Matter.World.add(o,m)},MapRenderer.prototype.initialize=function(){if(this.mData)for(let t in this.mData.layers)if(this.mData.layers[t].data){let o=new MapLayer(this.mData.layers[t],this.mTilesets,this.mShader);this.mLayers.push(o)}else this.createBody(this.mData.layers[t])},MapRenderer.prototype.draw=function(t){for(let o=0;o<this.mLayers.length;o++)this.mLayers[o].draw(this.mTransform.getMatrix(),t,this.mLights)},MapRenderer.prototype.setShader=function(t){for(let o=0;o<this.mLayers.length;o++)this.mLayers[o].setShader(t)},MapRenderer.prototype.getLayer=function(t){return this.mLayers[t]},MapRenderer.prototype.getTransform=function(){return this.mTransform},MapRenderer.prototype.getLightAt=function(t){return this.mLights[t]},MapRenderer.prototype.addLight=function(t){this.mLights.push(t)},MapRenderer.prototype.cleanUp=function(){};function FontRenderable(t){this.mFont=gEngine.DefaultResources.getDefaultFont(),this.mOneChar=new GameObject,this.mOneChar.setComponent(ComponetType.renderer,new SpriteRenderer(this.mFont+'.png')),this.mOneChar.renderer.setShader(gEngine.DefaultResources.getFontShader()),this.mTransform=new Transform,this.mText=t}FontRenderable.prototype.draw=function(t){var o=this.mTransform.getScaleX()/this.mText.length,a=this.mTransform.getScaleY(),n=this.mTransform.getPositionY(),m=this.mTransform.getPositionX()-o/2+0.5*o,d,u,g,C,f,T,S=this.mTransform.getRotation();this.mOneChar.transform.setRotation(S);for(var L=0,F=this.mText.length;L<F;L++)d=this.mText.charCodeAt(L),u=gEngine.Fonts.getCharInfo(this.mFont,d),this.mOneChar.renderer.setTextureCoordUV(u.mTexCoordLeft,u.mTexCoordRight,u.mTexCoordBottom,u.mTexCoordTop),g=o*u.mCharWidth,C=a*u.mCharHeight,this.mOneChar.transform.setScale([g,C,1]),f=0.5*(o*u.mCharWidthOffset),T=0.5*(Math.cos(S)*a*u.mCharHeightOffset),this.mOneChar.transform.setPosition([m-f,n-T,0]),this.mOneChar.draw(t),m+=o*Math.cos(S),n+=o*Math.sin(S)},FontRenderable.prototype.setText=function(t){this.mText=t,this.setTextHeight(this.mTransform.getScaleY())},FontRenderable.prototype.setFont=function(t){this.mFont=t,this.mOneChar.renderer.setTexture(this.mFont+'.png')},FontRenderable.prototype.setTextHeight=function(t){var o=gEngine.Fonts.getCharInfo(this.mFont,'A'.charCodeAt(0)),a=t*o.mCharAspectRatio;this.mTransform.setScale([a*this.mText.length,t,1])},FontRenderable.prototype.setColor=function(t){this.mOneChar.renderer.setColor(t)},FontRenderable.prototype.getColor=function(){return this.mOneChar.renderer.getColor()},FontRenderable.prototype.getTransform=function(){return this.mTransform},FontRenderable.prototype.getFont=function(){return this.mFont},FontRenderable.prototype.getText=function(){return this.mText};